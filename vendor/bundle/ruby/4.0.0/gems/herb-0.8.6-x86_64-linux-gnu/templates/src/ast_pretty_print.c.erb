#include "include/analyze_helpers.h"
#include "include/ast_node.h"
#include "include/ast_nodes.h"
#include "include/errors.h"
#include "include/pretty_print.h"
#include "include/token_struct.h"
#include "include/util.h"
#include "include/util/hb_buffer.h"

#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>

void ast_pretty_print_node(AST_NODE_T* node, const size_t indent, const size_t relative_indent, hb_buffer_T* buffer) {
  if (!node) { return; }

  bool print_location = true;

  hb_buffer_append(buffer, "@ ");
  hb_buffer_append_string(buffer, ast_node_human_type(node));
  hb_buffer_append(buffer, " ");

  if (print_location) { pretty_print_location(node->location, buffer); }

  hb_buffer_append(buffer, "\n");

  switch (node->type) {
    <%- nodes.each do |node| -%>
    case <%= node.type %>: {
      const <%= node.struct_type %>* <%= node.human %> = (<%= node.struct_type %>*) node;

      pretty_print_errors(node, indent, relative_indent, <%= node.fields.none? %>, buffer);
      <%- node.fields.each_with_index do |field, index| -%>
      <%- last = index == node.fields.length - 1 -%>
      <%- case field -%>
      <%- when Herb::Template::TokenField -%>
      pretty_print_token_property(<%= node.human %>-><%= field.name %>, hb_string("<%= field.name %>"), indent, relative_indent, <%= last %>, buffer);
      <%- when Herb::Template::ArrayField -%>
      pretty_print_array(hb_string("<%= field.name %>"), <%= node.human %>-><%= field.name %>, indent, relative_indent, <%= last %>, buffer);
      <%- when Herb::Template::BooleanField -%>
      pretty_print_boolean_property(hb_string("<%= field.name %>"), <%= node.human %>-><%= field.name %>, indent, relative_indent, <%= last %>, buffer);
      <%- when Herb::Template::ElementSourceField -%>
      pretty_print_string_property(element_source_to_string(<%= node.human %>-><%= field.name %>), hb_string("<%= field.name %>"), indent, relative_indent, <%= last %>, buffer);
      <%- when Herb::Template::StringField -%>
      pretty_print_string_property(hb_string(<%= node.human %>-><%= field.name %>), hb_string("<%= field.name %>"), indent, relative_indent, <%= last %>, buffer);
      <%- when Herb::Template::PrismNodeField -%>
      pretty_print_string_property(hb_string("<%= field.name %>"), hb_string("<%= field.name %>"), indent, relative_indent, <%= last %>, buffer);
      <%- when Herb::Template::NodeField -%>

      pretty_print_label(hb_string("<%= field.name %>"), indent, relative_indent, <%= last %>, buffer);

      if (<%= node.human %>-><%= field.name %>) {
        hb_buffer_append(buffer, "\n");
        pretty_print_indent(buffer, indent);
        pretty_print_indent(buffer, relative_indent + 1);

        hb_buffer_append(buffer, "└── ");
        ast_pretty_print_node((AST_NODE_T*) <%= node.human %>-><%= field.name %>, indent, relative_indent + 2, buffer);
      } else {
        hb_buffer_append(buffer, " ∅\n");
      }
      hb_buffer_append(buffer, "\n");

      <%- when Herb::Template::AnalyzedRubyField -%>
      if (<%= node.human %>-><%= field.name %>) {
        pretty_print_boolean_property(hb_string("if_node"), has_if_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("elsif_node"), has_elsif_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("else_node"), has_else_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("end"), has_end(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("block_node"), has_block_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("block_closing"), has_block_closing(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("case_node"), has_case_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("when_node"), has_when_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("for_node"), has_for_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("while_node"), has_while_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("until_node"), has_until_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("begin_node"), has_begin_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("rescue_node"), has_rescue_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("ensure_node"), has_ensure_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
        pretty_print_boolean_property(hb_string("unless_node"), has_unless_node(<%= node.human %>-><%= field.name %>), indent, relative_indent, false, buffer);
      } else {
      pretty_print_label(hb_string("<%= field.name %>"), indent, relative_indent, <%= last %>, buffer);
        hb_buffer_append(buffer, " ∅\n");
      }

      <%- when Herb::Template::VoidPointerField -%>
      pretty_print_label(hb_string("<%= field.name %>"), indent, relative_indent, <%= last %>, buffer);
      hb_buffer_append(buffer, " ?\n");

      <%- else -%>
      <%= field.inspect %>
      <%- end -%>
      <%- end -%>
    } break;

    <%- end -%>
  }
}
