#include "include/analyze.h"
#include "include/visitor.h"

bool transform_erb_nodes(const AST_NODE_T* node, void* data) {
  analyze_ruby_context_T* context = (analyze_ruby_context_T*) data;
  context->parent = (AST_NODE_T*) node;

  <%- nodes.each do |node| -%>
  <%- node.fields.each do |field| -%>
  <%- if field.is_a?(Herb::Template::ArrayField) && field.name != "errors" -%>
  if (node->type == <%= node.type %>) {
    <%= node.struct_type %>* <%= node.human %> = (<%= node.struct_type %>*) node;
    hb_array_T* old_array = <%= node.human %>-><%= field.name %>;
    <%= node.human %>-><%= field.name %> = rewrite_node_array((AST_NODE_T*) node, <%= node.human %>-><%= field.name %>, context);
    hb_array_free(&old_array);
  }

  <%- end -%>
  <%- end -%>
  <%- end -%>
  herb_visit_child_nodes(node, transform_erb_nodes, data);

  return false;
}
