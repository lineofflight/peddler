<%- base_arguments = [["type", "String"], ["location", "Location"], ["message", "String"]] -%>
module Herb
  module Errors
    class Error
      <%- base_arguments.each do |argument, type| -%>
      attr_reader :<%= argument %> #: <%= type %>
      <%- end -%>

      #: (<%= base_arguments.map { |_argument, type| type }.join(", ") %>) -> void
      def initialize(<%= base_arguments.map(&:first).join(", ") %>)
        <%- base_arguments.each do |argument, _type| -%>
        @<%= argument %> = <%= argument %>
        <%- end -%>
      end

      #: () -> serialized_error
      def to_hash
        {
          type: type,
          location: location&.to_hash,
          message: message,
        }
      end

      #: () -> String
      def class_name
        self.class.name || "Error"
      end

      #: () -> String
      def error_name
        class_name.split("::").last || "Error"
      end

      #: (?untyped) -> String
      def to_json(state = nil)
        to_hash.to_json(state)
      end

      #: (?indent: Integer, ?depth: Integer, ?depth_limit: Integer) -> String
      def tree_inspect(indent: 0, depth: 0, depth_limit: 25)
        raise NotImplementedError
      end
    end

    <%- errors.each do |error| -%>
    class <%= error.name -%> < Error
      include Colors
      <%- if error.fields.any? -%>

      <%- error.fields.each do |field| -%>
      attr_reader :<%= field.name %> #: <%= field.ruby_type %>
      <%- end -%>

      #: (<%= [*base_arguments.map(&:last), *error.fields.map(&:ruby_type)].join(", ") %>) -> void
      def initialize(<%= [*base_arguments.map(&:first), *error.fields.map(&:name)].join(", ") %>)
        super(<%= base_arguments.map(&:first).join(", ") %>)
        <%- error.fields.each do |field| -%>
        @<%= field.name %> = <%= field.name %>
        <%- end -%>
      end
      <%- end -%>

      #: () -> String
      def inspect
        tree_inspect.rstrip.gsub(/\s+$/, "")
      end
      <%- if error.fields.any? -%>

      #: () -> serialized_<%= error.human %>
      def to_hash
        super.merge(
          <%- error.fields.each_with_index do |field, index| -%>
          <%= field.name %>: <%= field.name %><%= index < error.fields.size - 1 ? "," : "" %>
          <%- end -%>
        ) #: Herb::serialized_<%= error.human %>
      end
      <%- end -%>

      #: (?indent: Integer, ?depth: Integer, ?depth_limit: Integer) -> String
      def tree_inspect(indent: 0, depth: 0, depth_limit: 25)
        output = +""

        output += white("@ #{bold(red(error_name))} #{dimmed("(location: #{location.tree_inspect})\n")}")
        <%- symbol = error.fields.none? ? "└──" : "├──" -%>
        output += white("<%= symbol %> message: #{green(message.inspect)}\n")
        <%- error.fields.each do |field| -%>
        <%- symbol = error.fields.last == field ? "└──" : "├──" -%>
        <%- case field -%>
        <%- when Herb::Template::PositionField -%>
        output += white("<%= symbol %> <%= field.name %>: ")
        output += <%= field.name %> ? <%= field.name %>.tree_inspect : magenta("∅")
        output += "\n"
        <%- when Herb::Template::TokenField -%>
        output += white("<%= symbol %> <%= field.name %>: ")
        output += <%= field.name %> ? <%= field.name %>.tree_inspect : magenta("∅")
        output += "\n"
        <%- when Herb::Template::TokenTypeField -%>
        output += white("<%= symbol %> <%= field.name %>: #{green(<%= field.name %>.inspect)}\n")
        <%- when Herb::Template::StringField -%>
        output += white("<%= symbol %> <%= field.name %>: #{green(<%= field.name %>.inspect)}\n")
        <%- else -%>
        output += white("<%= symbol %> <%= field.name %>: ") + '#{<%= field.name %>.class}'\n"
        <%- end -%>
        <%- end -%>
        output += %(\n)

        output.gsub(/^/, "    " * indent)
      end
    end

    <%- end -%>
  end
end
